## Возможности и ограничения парсинга Яндекс.Карт и 2ГИС

### 1. Яндекс.Карты

**Что парсер умеет забирать стабильно (по текущей верстке):**

- **По каждой карточке компании:**
  - Название (`card_name`)
  - Адрес (`card_address`)
  - Средний рейтинг карточки (`card_rating`)
  - Количество отзывов (`card_reviews_count`)
  - Телефон, сайт, рубрики (`card_phone`, `card_website`, `card_rubrics`)
  - Количество отзывов с ответом и без ответа:
    - `card_answered_reviews_count`
    - `card_unanswered_reviews_count`
  - Среднее время ответа компании (`card_avg_response_time`)
  - Количество отзывов по новой схеме тональности:
    - **негативные (1–2⭐)**,
    - **нейтральные (3⭐)**,
    - **позитивные (4–5⭐)**.
    - `card_reviews_negative`, `card_reviews_neutral`, `card_reviews_positive`

- **По каждому отзыву (в `detailed_reviews`):**
  - Автор (`review_author`)
  - Дата (`review_date`)
  - Оценка отзыва в звёздах (`review_rating`, 1–5)
  - Текст (`review_text`)
  - Признак и текст ответа компании:
    - `has_response`
    - `response_text`
    - `response_date`

- **В агрегированной статистике по Яндексу:**
  - Количество найденных карточек (`total_cards_found`)
  - Средний рейтинг компании (взвешенный по числу отзывов) (`aggregated_rating`)
  - Общее количество отзывов (`aggregated_reviews_count`)
  - Количество отзывов с ответом / без ответа и процент ответов:
    - `aggregated_answered_reviews_count`
    - `aggregated_unanswered_reviews_count`
    - `aggregated_answered_reviews_percent`
  - Средняя скорость ответа компании (`aggregated_avg_response_time`):
    - считается честно, **только если в HTML есть и дата отзыва, и дата ответа**;
    - если Яндекс дату ответа не показывает, в отчёте явно пишем «недоступно — ориентируйтесь по доле отвеченных».
  - Количество отзывов по тональности (среди отзывов с оценкой):
    - `aggregated_negative_reviews` — **негативные (1–2⭐)**,
    - `aggregated_neutral_reviews` — **нейтральные (3⭐)**,
    - `aggregated_positive_reviews` — **позитивные (4–5⭐)**.

**Итог по Яндексу:**  
По Яндекс.Картам парсер **полностью закрывает требования ТЗ по отзывам и рейтингам**:

- детальные отзывы с оценкой 1–5;
- разделение отзывов по тональности по схеме **1–2⭐ негатив / 3⭐ нейтрал / 4–5⭐ позитив**;
- честная агрегация по всем карточкам (количество карточек, рейтинг, доля негативных и т.п.).

Ограничение только одно: **средняя скорость ответа** считается там, где Яндекс отрисовывает дату ответа; если дата ответа отсутствует, метрика недоступна, но мы считаем и показываем долю отвеченных отзывов.

#### 1.1. Как считаем количество карточек и работаем с «поиском по стране»

- **Количество карточек в отчёте (`total_cards_found`)**:
  - считаем **только реальные карточки организаций** по URL вида `/maps/org/...`,
  - не считаем:
    - агрегированные списки филиалов/сетей,
    - служебные блоки и гео‑точки без отдельной карточки.
- **Как ищем все карточки по запросу:**
  - на странице поиска Яндекс:
    - используем комбинацию **пагинации** (`?page=2,3,...`) и **постепенной прокрутки** (дозированный scroll) до тех пор, пока:
      - появляются новые карточки, и
      - не достигнут лимит `max_records` в конфиге (по умолчанию до 1000 карточек).
- **Поиск «по всей стране»**:
  - Яндекс технически ограничивает количество выдаваемых организаций в одном поисковом листинге,
  - поэтому для федеральных сетей (по всей РФ) парсер даёт **репрезентативную, но не исчерпывающую** выборку:
    - число карточек — это все найденные уникальные `org`‑карточки в текущем листинге и его страницах,
    - для полного охвата страны нужны отдельные запросы по городам/регионам.

---

### 2. 2ГИС

#### 2.1. Данные карточки (уровень организации)

**Что парсер умеет забирать стабильно:**

- **Поиск и список карточек:**
  - Нормализованные ссылки фирм/станций вида  
    `https://2gis.ru/{city}/{kind}/{id}` (firm/station).

- **По каждой карточке:**
  - Название (`card_name`)
  - Адрес (`card_address`)
  - Средний рейтинг карточки (`card_rating` — например, 4.6)
  - Количество оценок/отзывов, привязанных к карточке
  - Телефон, сайт, рубрики (если они есть в верстке)

#### 2.2. Данные отзывов (вкладка «Отзывы»)

По сохранённому HTML и живой верстке вкладки `/tab/reviews`:

- **По каждому отзыву можно вытащить надёжно:**
  - Имя/автор (`review_author`)
  - Дата отзыва (`review_date`)
  - Текст отзыва (`review_text`)
  - Наличие и текст ответа магазина:
    - `has_response`
    - `response_text`
    - `response_date`

- **Что важно:**
  - У каждого отзыва в DOM есть ряд из **5 иконок-звёзд** (`img`), но:
    - НЕТ текста вида `5 из 5`,
    - НЕТ атрибутов `aria-label="5 из 5"`, `data-rating`, `rating` и т.п.,
    - НЕТ различимых CSS‑классов/атрибутов, по которым можно понять, какие именно звёзды активны.
  - В сохранённом HTML:
    - нет строк с `"rating"`, `звезд/звёзд`, `star` в контексте оценки именно отзыва,
    - звёзды выглядят как обычные картинки, без данных о заполненности.

**Следствие:**  
Из текущей публичной HTML‑верстки 2ГИС **невозможно честно восстановить численный рейтинг (1–5) для каждого отдельного отзыва**:

- 2ГИС отдаёт только:
  - общий рейтинг карточки (4.6, 131 оценка),
  - набор отзывов с текстами и датами,
  - ответы компании.
- Но **число звёзд по каждому отзыву в явном виде не отдается** — ни в тексте, ни в атрибутах.

#### 2.3. Что мы можем считать по 2ГИС

**Точно и корректно:**

- По карточкам:
  - `card_name`, `card_address`, `card_rating`, `card_reviews_count`, контакты.

- По отзывам:
  - `review_author`, `review_date`, `review_text`,
  - `has_response`, `response_text`, `response_date`.

- В агрегации по 2ГИС:
  - Количество карточек (`total_cards_found`)
  - Общее число отзывов (`aggregated_reviews_count`)
  - Количество отзывов с ответом / без ответа:
    - `aggregated_answered_reviews_count`
    - `aggregated_unanswered_reviews_count`
  - Среднее время ответа компании (`aggregated_avg_response_time`)

При этом:

- `card_avg_response_time` / `aggregated_avg_response_time` по 2ГИС считаются по той же логике, что и для Яндекса:
  - только если в HTML есть и дата отзыва, и дата ответа,
  - если даты ответа нет, метрика для конкретного отзыва не учитывается в среднем.

**Что остаётся ограничением и как мы это обходим сейчас:**

- По HTML 2ГИС по‑прежнему **нельзя честно получить `review_rating` 1–5 для каждого отзыва** (нет текстового/атрибутного признака «сколько звёзд»).
- Поэтому мы используем **гибридный подход**:
  - если по верстке удаётся определить количество «заполненных» звёзд, то для таких отзывов применяем ту же схему, что и для Яндекса:  
    **1–2⭐ негатив, 3⭐ нейтрал, 4–5⭐ позитив**;
  - если по карточке не удаётся восстановить звёзды по отзывам, включаем **Variant B2**:
    - программно кликаем фильтры 2ГИС «Положительные» и «Отрицательные» на вкладке отзывов,
    - считаем количество отзывов под каждым фильтром,
    - сохраняем это как **оценочное** число позитивных/негативных отзывов по карточке;
  - при отсутствии надёжного `card_rating` по карточкам мы дополнительно считаем **примерный общий рейтинг** по схеме:
    - негативные ≈ 2 балла,
    - позитивные ≈ 4.5 балла,
    - `aggregated_rating ≈ (neg * 2.0 + pos * 4.5) / (neg + pos)`.

То есть:

- per‑review `review_rating` для 2ГИС **в целом недоступен**;
- но **количество позитивных/негативных отзывов и примерный общий рейтинг** мы считаем и явно помечаем в отчёте как **оценочные, по фильтрам 2ГИС**.

#### 2.4. Что именно считаем «карточкой» в 2ГИС и почему числа отличаются от «Места N»

- В интерфейсе 2ГИС у поиска показывается счётчик вида **«Места 82»**, куда попадают:
  - реальные карточки фирм/станций (`/firm/ID`, `/station/ID`),
  - общие списки филиалов (`/branches/...`),
  - гео‑точки, служебные элементы и др.
- Парсер **намеренно считает карточками только реальные организации** — URL вида:
  - `https://2gis.ru/{city}/firm/{id}`,
  - `https://2gis.ru/{city}/station/{id}`.
- Поэтому:
  - число карточек в отчёте (например, 40) — это **количество уникальных организаций**;
  - число «Места 82» на сайте — это все объекты, включая списки и служебные сущности.

Это надо учитывать при сравнении цифр отчёта с цифрами, которые пишет 2ГИС в UI.

#### 2.5. Как считаем количество карточек и обрабатываем страницы

- **Что считаем карточкой (`total_cards_found`)**:
  - только URL вида:
    - `https://2gis.ru/{city}/firm/{id}`,
    - `https://2gis.ru/{city}/station/{id}`;
  - все остальные объекты списка поиска (ветки, списки филиалов, гео‑точки) в отчёт не попадают.
- **Как обходим результаты:**
  - на первой странице поиска:
    - собираем все ссылки пагинации `/search/.../page/2`, `/page/3`, ...,
    - ограничиваемся разумным числом страниц (по умолчанию до 20);
  - для каждой страницы:
    - переходим по URL,
    - выполняем дозированный scroll до стабилизации количества карточек,
    - собираем все найденные `firm`/`station`‑ссылки;
  - итоговый `total_cards_found` — это **количество уникальных таких ссылок** (без дублей).
- **Почему цифры отличаются от «Места N»:**
  - UI 2ГИС считает **все объекты**, мы — только полноценные карточки организаций;
  - поэтому в отчёте обычно меньше карточек, но это число точнее отражает количество **уникальных точек бренда**.

---

### 3. Итоговое соответствие ТЗ

**ТЗ (упрощённо):**

- Количество найденных карточек.
- Общий рейтинг компании.
- Общее число отзывов.
- Число отзывов с ответом и без.
- Средняя скорость ответа.
- Разделение отзывов по тональности (по нашим правилам). 
- Возможность просмотреть текст каждого отзыва и его оценку.

**Что мы даём в отчёте:**

- **Яндекс.Карты — ТЗ по отзывам и рейтингу закрыто полностью:**
  - per‑review `review_rating 1–5`,
  - честное разделение по схеме **1–2⭐ негатив / 3⭐ нейтрал / 4–5⭐ позитив**,
  - средняя скорость ответа по датам отзывов/ответов там, где Яндекс отдаёт дату ответа.

- **2ГИС — ТЗ закрыто частично, с оговорками:**
  - Есть:
    - карточки (рейтинг, контакты, количество отзывов),
    - тексты отзывов,
    - ответы магазина,
    - общее число отзывов, отвеченных/нет, средняя скорость ответа,
    - оценочные количества **негативных (1–2⭐)** и **позитивных (4–5⭐)** отзывов по карточкам (через фильтры «Положительные/Отрицательные» и/или по звёздам там, где возможно),
    - примерный сводный рейтинг по 2ГИС, если карточный рейтинг недоступен.
  - Нет в строгом виде (по данным HTML):
    - надёжного `review_rating` 1–5 **для каждого** отзыва,
    - 100% точного разделения отзывов по звёздам без использования эвристик и фильтров UI.

**Вывод для принятия решений:**

- Для **Яндекса** можно смело строить детальную аналитику по звёздам и тональности — это честные данные сервиса.
- Для **2ГИС**:
  - можно использовать:
    - количество карточек‑организаций,
    - общее число отзывов,
    - ответы и скорость реакции,
    - оценочное разделение на негатив/позитив и примерный общий рейтинг;
  - нужно помнить, что тональность по 2ГИС основана на **эвристиках (фильтры UI + частичный парсинг звёзд)**, а не на официально отдаваемых per‑review рейтингах. 


