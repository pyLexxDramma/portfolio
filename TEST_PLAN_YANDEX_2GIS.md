## Тест-план для Unified Parser (Яндекс.Карты и 2ГИС)

### 1. Цель

Проверить, что парсер корректно собирает и агрегирует данные по Яндекс.Картам и 2ГИС **в пределах описанных ограничений** (см. `YANDEX_2GIS_DATA_LIMITS.md`), а также что ожидаемые расхождения с UI сервисов не воспринимаются как баги.

---

### 2. Предусловия

- Доступ к веб-интерфейсу парсера: `https://<домен>/parser` (учтите префикс `URL_PREFIX=/parser`).
- Работает systemd-сервис `unified-parser` и контейнер с Selenium (`selenium/standalone-chrome`).
- Есть логин/пароль для входа в веб-приложение.
- **Тестовый стенд и доступ:**
  - Вход в парсер: `https://test.pbd.space/parser/login`
  - После логина: `https://test.pbd.space/parser/`
  - Пароль для входа: **`admin123`**
- Возможность запустить полный цикл парсинга на стенде (зайти в браузере на `https://test.pbd.space/parser/login` → авторизоваться → перейти на `https://test.pbd.space/parser/` → заполнить форму и запустить парсинг).
- Подготовлены 2–3 тестовых бренда:
  - **Бренд A** — локальный бизнес в одном городе (есть карточки и отзывы и в Яндекс, и в 2ГИС).
  - **Бренд B** — федеральная сеть с большим количеством филиалов по РФ (для проверки «поиска по стране» и лимитов).
  - **Бренд C** — бизнес с заметным количеством отзывов в 2ГИС и фильтрами «Положительные/Отрицательные».

---

### 3. Сценарий: Яндекс.Карты (один город, детальные проверки)

**Цель:** подтвердить, что по Яндексу парсер честно восстанавливает карточки, отзывы и тональность в полном соответствии с ТЗ и версткой.

**Шаги:**
1. Авторизоваться в веб-интерфейсе парсера.
2. В форме задать параметры:
   - Источник: `Yandex` (или `both`).
   - Поиск по **одному конкретному городу** (город Бренда A).
   - Заполнить остальные поля (название, сайт, email) валидными значениями.
3. Запустить парсинг и дождаться статуса `COMPLETED`.
4. Открыть страницу статуса задачи:
   - проверить агрегированные метрики (блок «Агрегированные метрики»);
   - при необходимости скачать PDF и/или CSV.
5. Вручную открыть в Яндекс.Картах 3–5 карточек того же бренда (по тому же запросу и городу).
6. Сравнить по этим карточкам:
   - **уровень карточки**:
     - название (`card_name`),
     - адрес (`card_address`),
     - средний рейтинг (`card_rating`),
     - количество отзывов (`card_reviews_count`);
   - **уровень отзыва** (по выборке 5–10 отзывов):
     - автор (`review_author`),
     - дата (`review_date`),
     - оценка в звёздах (`review_rating`, 1–5),
     - текст (`review_text`),
     - наличие/текст ответа (`has_response`, `response_text`, `response_date`).

**Ожидаемый результат:**
- Детальные данные по Яндексу совпадают с UI (допускаются единичные расхождения при быстрой смене отзывов в онлайне).
- Агрегированные метрики по Яндексу корректны:
  - `total_cards_found`,
  - `aggregated_rating`,
  - `aggregated_reviews_count`,
  - `aggregated_answered_reviews_count`,
  - `aggregated_unanswered_reviews_count`,
  - `aggregated_answered_reviews_percent`,
  - `aggregated_negative_reviews`, `aggregated_neutral_reviews`, `aggregated_positive_reviews`.
- Средняя скорость ответа (`aggregated_avg_response_time`) считается только там, где в HTML есть и дата отзыва, и дата ответа; если даты ответа нет, это корректно отражено (нет деления на 0, нет «выдуманных» значений).

---

### 4. Сценарий: Яндекс.Карты — поиск «по стране» и лимит карточек

**Цель:** подтвердить, что при поиске «по всей стране» парсер выдаёт репрезентативную, но не бесконечную выборку, ограниченную настройками и возможностями Яндекса.

**Шаги:**
1. В веб-интерфейсе выбрать:
   - Источник: `Yandex` или `both`.
   - Режим поиска: `по стране` (или аналогичный, в зависимости от UI).
   - Бренд B (федеральная сеть).
2. Запустить парсинг, дождаться `COMPLETED`.
3. Зафиксировать:
   - значение `total_cards_found` в отчёте;
   - примерный порядок числа карточек в Яндекс.Картах (по тому же бренду, но с ручным обходом разных городов/страниц).

**Ожидаемый результат:**
- `total_cards_found` **не превышает** разумного лимита (см. `max_records` в конфиге, обычно до ~1000) и соответствует формату:
  - уникальные карточки организаций `org`, а не все возможные упоминания бренда.
- Если Яндекс в UI показывает больше потенциальных мест, чем указано в `total_cards_found`, это **ожидаемое ограничение**, а не баг:
  - парсер собирает **все доступные уникальные карточки в рамках лимитов выдачи и конфигурации**, а не бесконечный по стране список.

---

### 5. Сценарий: 2ГИС — карточки и отзывы (без упора на пер-отзывные звёзды)

**Цель:** убедиться, что по 2ГИС корректно собираются карточки, отзывы и ответы, а ограничения по per‑review звёздам учитываются.

**Шаги:**
1. В веб-интерфейсе задать:
   - Источник: `2gis` (или `both`).
   - Поиск по одному городу (Бренд A).
2. Запустить парсинг, дождаться `COMPLETED`.
3. Открыть 3–5 карточек Бренда A в 2ГИС:
   - сравнить:
     - `card_name`, `card_address`, `card_rating`, `card_reviews_count`,
     - список отзывов по выборке:
       - `review_author`, `review_date`, `review_text`,
       - наличие/текст ответа (`has_response`, `response_text`, `response_date`).
4. Проверить агрегированные метрики для 2ГИС в отчёте:
   - `total_cards_found`,
   - `aggregated_reviews_count`,
   - `aggregated_answered_reviews_count`,
   - `aggregated_unanswered_reviews_count`,
   - `aggregated_avg_response_time`.

**Ожидаемый результат:**
- Карточки и отзывы по 2ГИС совпадают с UI (название, адрес, рейтинг, количество отзывов, тексты, ответы).
- Агрегированные метрики по 2ГИС корректны.
- Тестировщик **не ожидает** наличия честного `review_rating 1–5` у каждого отдельного отзыва — это описанное ограничение сервиса (см. `YANDEX_2GIS_DATA_LIMITS.md`), поэтому отсутствие таких данных не считается багом.

---

### 6. Сценарий: 2ГИС — различие с «Места N» и оценочные тональности

**Цель:** зафиксировать ожидаемое отличие между `total_cards_found` в отчёте и счетчиком «Места N» в UI 2ГИС, а также проверить оценочные позитив/негатив по фильтрам.

**Шаги:**
1. В 2ГИС найти запрос для Бренда C, где в интерфейсе поиска отображается счётчик вида **«Места N»**.
2. В парсере выполнить тот же запрос (источник 2ГИС, тот же город/регион).
3. Сравнить:
   - `total_cards_found` из отчёта;
   - значение «Места N» в UI 2ГИС.
4. Для 1–2 выбранных карточек в UI 2ГИС:
   - включить фильтр «Положительные» и посчитать количество отзывов;
   - включить фильтр «Отрицательные» и посчитать количество отзывов;
   - сравнить с оценочными метриками в отчёте (поля, соответствующие количеству позитивных/негативных отзывов по карточке).

**Ожидаемый результат:**
- `total_cards_found` **меньше или равно** «Места N»:
  - отчёт учитывает только реальные карточки организаций (`/firm/{id}`, `/station/{id}`), а не списки и служебные сущности;
  - это ожидаемое и корректное поведение.
- Количество позитивных/негативных отзывов в отчёте по карточке:
  - по порядку величины совпадает с тем, что видно под фильтрами «Положительные» / «Отрицательные»;
  - небольшие расхождения допустимы (UI может частично подгружать отзывы, часть скрывать);
  - метрики явно трактуются как **оценочные**, а не «официальные per‑review звёзды».

---

### 7. Негативные и граничные сценарии

**Цель:** убедиться, что парсер корректно обрабатывает случаи с малым количеством данных.

**Шаги / кейсы:**
1. Бренд без отзывов:
   - Запуск для бренда, у которого 0–1 отзыв в Яндексе и/или 2ГИС.
   - Ожидаемое поведение:
     - `aggregated_reviews_count` близко к 0,
     - нет деления на 0 в процентах и средней скорости ответа,
     - в UI и отчёте аккуратно отображаются «0 отзывов» / «данные недоступны».
2. Бренд с 1–2 карточками:
   - Проверить, что при очень малом числе карточек агрегированные метрики считаются корректно и интерфейс не ломается (нет пустых таблиц с ошибками).

---

### 8. Критерии принятия

- По Яндекс.Картам:
  - Детальные отзывы и рейтинги в отчёте соответствуют UI.
  - Агрегированные метрики по отзывам, тональности и скорости ответа корректны.
- По 2ГИС:
  - Детальные карточки и отзывы корректны.
  - Агрегированные показатели по количеству отзывов, ответам и скорости реакции корректны.
  - Отличие `total_cards_found` от «Места N» объясняется и воспринимается как **особенность** (считаются только реальные карточки).
  - Тестировщик осознаёт ограничение по per‑review `review_rating` и оценочному характеру тональности в 2ГИС.


